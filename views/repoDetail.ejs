<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= repoName %> - Repository</title>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .sidebar {
            width: 300px;
            background-color: #f4f4f4;
            border-right: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .file-content {
            white-space: pre-wrap;
            background: #f9f9f9;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 400px; /* ë†’ì´ë¥¼ ì œí•œí•˜ì—¬ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
            overflow-y: auto;
        }
        .editor {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            padding: 10px;
            font-family: monospace;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        .repo-actions {
            text-align: right;
            margin-bottom: 20px;
        }
        .repo-actions button {
            padding: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .repo-actions button:disabled {
            background-color: #ccc;
        }
        /* íŒŒì¼ ëª©ë¡ì„ ë³´ê¸° ì¢‹ê²Œ ì •ë ¬ */
        .file-list {
            margin-top: 10px;
        }
        .file-list div {
            margin-bottom: 10px;
        }
        .file-list a {
            color: #007bff;
            text-decoration: none;
        }
        .file-list a:hover {
            text-decoration: underline;
        }
        .file-list button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .file-list button:disabled {
            background-color: #ccc;
        }
        /* íŒŒì¼ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
        .upload-section {
            margin-top: 20px;
        }
        .upload-section input {
            padding: 5px;
            font-size: 14px;
        }
        .upload-section button {
            margin-left: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .upload-section button:disabled {
            background-color: #ccc;
        }
    </style>
</head>
<body>
<div class="sidebar">
    <h3>Directories</h3>
    <div class="file-list">
        <% files.forEach(file => { %>
            <div>
                <% if (file.isFolder) { %>
                    ğŸ“ <%= file.File_name %>
                <% } else { %>
                    ğŸ“„
                    <a href="#" onclick="loadFile('<%= file.Path %>')"><%= file.File_name %></a>
                    <% if (isOwner) { %>
                        <button onclick="deleteFile('<%= file.Path %>', '<%= repoId %>')">Delete</button>
                    <% } %>
                <% } %>
            </div>
        <% }); %>
    </div>
</div>

<div class="content">
    <div class="repo-actions">
        <% if (isOwner) { %>
            <button onclick="deleteRepo('<%= repoId %>')">Delete Repository</button>
        <% } %>
    </div>

    <h1>File Viewer & Editor</h1>
    <div id="file-content" class="file-content">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    <textarea id="editor" class="editor" placeholder="íŒŒì¼ ë‚´ìš©ì„ í¸ì§‘í•˜ì„¸ìš”."></textarea>

    <% if (isOwner) { %>
        <button onclick="saveFile()">Save File</button>
    <% } else { %>
        <button disabled>Save File</button>
    <% } %>

    <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
    <% if (isOwner) { %>
        <div class="upload-section">
            <label for="file-upload">íŒŒì¼ ì—…ë¡œë“œ:</label>
            <input type="file" id="file-upload" name="file">
            <input type="hidden" name="repoId" value="<%= repoId %>">
            <button onclick="uploadFile()">Upload</button>
        </div>
    <% } %>
</div>

<script>
    let currentFilePath = null;
    let start = '<%= initialFilePath %>';
    if(start){
        loadFile(start);
    }
    async function loadFile(filePath) {
        currentFilePath = filePath;
        try {
            const response = await fetch(`/repoDetail/file-content?path=${encodeURIComponent(filePath)}`);
            console.log('í˜„ì¬ íŒŒì¼ ê²½ë¡œ: ', currentFilePath);
            if (!response.ok) throw new Error('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            const content = await response.text();
            document.getElementById('file-content').textContent = content;
            document.getElementById('editor').value = content;
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
        }
    }

    async function saveFile() {
        const content = document.getElementById('editor').value;
        if (!currentFilePath) {
            alert('ì €ì¥í•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        console.log('ë³´ë‚¼ íŒŒì¼ ê²½ë¡œ:', currentFilePath);
        console.log('ë³´ë‚¼ íŒŒì¼ ë‚´ìš©:', content);

        try {
            const response = await fetch('/repoDetail/edit-file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ filePath: currentFilePath, content }),
            });
            if (!response.ok) throw new Error('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨');
            alert(await response.text());
            location.reload();
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
        }
    }

    async function deleteFile(filePath, repoId) {
        if (!filePath) {
            alert('ì‚­ì œí•  íŒŒì¼ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const confirmDelete = confirm('ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmDelete) return;

        try {
            const response = await fetch('/repoDetail/delete-file', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filePath: filePath,
                    repoId: repoId  // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ repoId
                }),
            });
            if (!response.ok) throw new Error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨');
            alert(await response.text());
            location.reload();  // ì‚­ì œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
        }
    }

    async function deleteRepo(repoId) {
        const confirmDelete = confirm('ì •ë§ë¡œ ì´ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmDelete) return;

        try {
            const response = await fetch('/repoDetail/delete-repo', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    repoId: repoId
                }),
            });
            if (!response.ok) throw new Error('ë ˆí¬ì§€í† ë¦¬ ì‚­ì œ ì‹¤íŒ¨');
            alert(await response.text());
            window.location.href = '/';  // ë ˆí¬ì§€í† ë¦¬ ì‚­ì œ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
        }
    }

    async function uploadFile() {
        const fileInput = document.getElementById('file-upload');
        const repoId = document.querySelector('input[name="repoId"]').value;
        const file = fileInput.files[0];
        if (!file) {
            alert('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('repoId', repoId);

        try {
            const response = await fetch('/repoDetail/upload-file', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
            alert(await response.text());
            location.reload();  // ì—…ë¡œë“œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
        }
    }
</script>
</body>
</html>
