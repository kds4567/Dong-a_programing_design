<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= repoName %> - Repository</title>
    <style>
        .file-content {
            white-space: pre-wrap;
            background: #f9f9f9;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .editor {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            padding: 10px;
            font-family: monospace;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        /* ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .button-container {
            display: flex; /* Flexbox ì‚¬ìš© */
            gap: 1px; /* ë²„íŠ¼ ê°„ ê°„ê²© */
            /* margin-bottom: 20px; */
        }
        .repo-actions {
            text-align: right;
            margin-bottom: 20px;
        }
        .repo-actions button {
            width: 130px;
            margin-right: 20px;
            padding: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .repo-actions button:disabled {
            background-color: #ccc;
        }
        .file-list {
            margin-top: 10px;
        }
        .file-list div {
            margin-bottom: 10px;
        }
        .file-list a {
            color: #007bff;
            text-decoration: none;
        }
        .file-list a:hover {
            text-decoration: underline;
        }
        .file-list button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .file-list button:disabled {
            background-color: #ccc;
        }
        .upload-section {
            margin-top: 20px;
        }
        .upload-section input {
            padding: 5px;
            font-size: 14px;
        }
        .upload-section button {
            margin-left: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .save-file button {
            width: 130px;
            /* margin-left: 10px; */
            margin-right: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .save-file button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .upload-section button:disabled {
            background-color: #ccc;
        }

        /* create ë²„íŠ¼ ë° upload ë²„íŠ¼*/
        .dropdown {
            position: relative;
            z-index: 10; /* z-indexë¥¼ ë†’ì—¬ì„œ ë²„íŠ¼ì´ ì•ì— ë‚˜ì˜¤ê²Œ í•¨ */
            background-color: white; /* ë°°ê²½ìƒ‰ ì¶”ê°€ë¡œ ë” ì˜ ë³´ì´ë„ë¡ */
            display: inline-block;
        }

        .dropdown-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            z-index: 10;
            overflow: hidden;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: black;
            font-size: 14px;
        }

        .dropdown-menu a:hover {
            background-color: #f0f0f0;
        }

        .dropdown.show .dropdown-menu {
            display: block;
        }

        /* Upload Modal Styling */
        .upload-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
        }

        .upload-modal h2 {
            margin-bottom: 20px;
            font-size: 22px;
        }

        .upload-modal label {
            margin-right: 10px;
        }

        .upload-modal button {
            margin-top: 20px;
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .upload-modal button:hover {
            background-color: #218838;
        }

        /* Modal background overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }

        .footer-area {
            margin-top: auto;
        }
        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .content {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding: 160px 20px 10px; /* ìƒë‹¨ë°” ë†’ì´ë§Œí¼ padding ì¶”ê°€ */
        }

        .sidebar {
            width: 25%; /* ì‚¬ì´ë“œë°” í¬ê¸° */
            background-color: #f4f4f4;
            padding: 20px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            width: 70%;
            padding: 20px;
            background-color: #fff;
        }

        .editor-header, .file-list, .file-content, .editor {
            margin-bottom: 20px;
        }

        .editor {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ccc;
        }

        /* ìƒë‹¨ë°” ìŠ¤íƒ€ì¼ */
        .header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-links a {
            color: white;
            margin: 0 10px;
            text-decoration: none;
        }

        .header-actions .logout {
            background-color: #ff6b6b;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
        }


    </style>
    <!--top bar css-->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/line-awesome.min.css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
<!--top bar-->
<header class="header-area">
    <div class="top-header">
        <div class="container">
            <div class="row align-items-center justify-content-center">
                <div class="col-lg-6 col-sm-6">
                    <ul class="left-info">
                        <li>
                            <a href="mailto:hello@atorn.com">
                                <i class="las la-envelope"></i>
                                swdesign@donga.ac.kr
                            </a>
                        </li>
                        <li>
                            <a href="tel:+823-456-879">
                                <i class="las la-phone"></i>
                                +82 1234 5678
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-lg-6 col-sm-6">
                    <ul class="right-info">
                        
                        <li class="heder-btn">
                            <!--myrepository ìƒì„± html ì—°ê²°-->
                            <a href="/logout">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Navbar Area -->
    <div class="navbar-area">
        <div class="atorn-responsive-nav">
            <div class="container">
                <div class="atorn-responsive-menu">
                    <div class="logo">
                            <img src="/images/Donga_logo1.png" class="logo1" alt="logo">
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="atorn-nav">
            <div class="container">
                <nav class="navbar navbar-expand-md navbar-light">
                    <a class="navbar-brand">
                        <img src="/images/Donga_logo1.png" class="logo1" alt="logo">
                    </a>

                    <div class="collapse navbar-collapse mean-menu">
                        <ul class="navbar-nav ms-auto">
                            <!--<li class="nav-item">
                                <a href="" class="nav-link">
                                    My Repository
                                </a>
                            </li>-->
                            <li class="nav-item">
                                <!--ê°€ì´ë“œ í˜ì´ì§€ html ì—°ê²°-->
                                <a href="/" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <!--ê°€ì´ë“œ í˜ì´ì§€ html ì—°ê²°-->
                                <a href="/#ct-real" class="nav-link">Share Repo</a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    FAQ <i class="las la-angle-down"></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li class="nav-item">
                                        <!--FAQ html ì—°ê²°-->
                                        <a href="" class="nav-link">FAQ ì‘ì„±</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="" class="nav-link">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <!--ê°€ì´ë“œ í˜ì´ì§€ html ì—°ê²°-->
                                <a href="" class="nav-link">Guide Page</a>
                            </li>
                            <li class="nav-item">
                                <a href="javascript:void(0)" class="nav-link search-box">
                                    <i class="las la-search"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
    <!-- End Navbar Area -->
   
</header>

    
<main class="content">
    
    <div class="sidebar">
        <!-- Sidebar ë‚´ìš© -->
        <div class="editor-header">
            <h2>Files</h2>
            <div class="dropdown">
                <button class="dropdown-button" onclick="toggleDropdown()">+</button>
                <div class="dropdown-menu">
                    <a href="#" onclick="createFile('<%= repoId %>')">Create file</a>
                    <a href="#" onclick="openUploadModal()">Upload file</a>
                </div>
            </div>
            <div class="modal-overlay" id="modal-overlay"></div>
            <div class="upload-modal" id="upload-modal">
                <label for="file-upload">íŒŒì¼ ì—…ë¡œë“œ:</label>
                <input type="file" id="file-upload" name="file">
                <input type="hidden" name="repoId" value="<%= repoId %>">
                <button onclick="uploadFile()">Upload</button>
            </div>
        </div>

        <div class="file-list">
            <% files.forEach(file => { %>
            <div>
                <% if (file.isFolder) { %>
                    ğŸ“ <%= file.File_name %>
                <% } else { %>
                    ğŸ“„
                    <a href="#" onclick="loadFile('<%= file.Path %>')"><%= file.File_name %></a>
                    <% if (isOwner) { %>
                        <button onclick="deleteFile('<%= file.Path %>', '<%= repoId %>')">Delete</button>
                    <% } %>
                <% } %>
            </div>
            <% }); %>
        </div>
    </div>

    <div class="main-content">
        <div class="editor-header">
            <h1>File Viewer</h1>
            <div class="button-container">
                <div class="save-file">
                    <% if (isOwner) { %>
                        <button onclick="saveFile()">Save File</button>
                    <% } else { %>
                        <button disabled>Save File</button>
                    <% } %>
                </div>
                <div class="repo-actions">
                    <% if (isOwner) { %>
                        <button onclick="deleteRepo('<%= repoId %>')">Delete Repo</button>
                    <% } %>
                </div>
            </div>
        </div>

        <div id="file-content" class="file-content">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>

        <h1>Editor</h1>
        <textarea id="editor" class="editor" placeholder="íŒŒì¼ ë‚´ìš©ì„ í¸ì§‘í•˜ì„¸ìš”."></textarea>
    </div>
</main>




    <footer class="footer-area pt-100 pb-70">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-5 col-sm-6">
                    <div class="footer-widget">
                        <div class="logo">
                            <img src="/images/Donga_logo2.png" alt="logo">
                        </div>
                        <p>You can design better software through Dong-A University design code, and get better design code ideas through the sharing page.</p>

                        <ul class="footer-socials">
                            <li>
                                <a href="https://www.facebook.com/login/" target="_blank">
                                    <i class="lab la-facebook-f"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/i/flow/login" target="_blank">
                                    <i class="lab la-twitter"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.instagram.com/" target="_blank">
                                    <i class="lab la-instagram"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.google.co.uk/" target="_blank">
                                    <i class="lab la-google-plus"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-2 col-sm-6">
                    <div class="footer-widget">
                        <h3>PM</h3>
                
                        <ul class="footer-text">
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Juseok Son
                                </a>
                            </li>
                            <li>
                                <a href="/myrepo">
                                    <i class="las la-star"></i>
                                    Daeseong Kim
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="col-lg-2 col-sm-6">
                    <div class="footer-widget pl-50">
                        <h3>Font-end</h3>

                        <ul class="footer-text">
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Jaeung Lee
                                </a>
                            </li>
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Subin Choi
                                </a>
                            </li>
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Yeonghun Jeong
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-3 col-sm-6">
                    <div class="footer-widget pl-50">
                        <h3>Back-end</h3>

                        <ul class="footer-text">
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Heewoong Jang
                                </a>
                            </li>
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Minsu Kim
                                </a>
                            </li>
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Sehyeon Kim
                                </a>
                            </li>
                            <li>
                                <a href="">
                                    <i class="las la-star"></i>
                                    Seongmin Im
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </footer>

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
        <script>
            let start = '<%= initialFilePath %>';
            if (start){
                console.log('initialFilePath : ', start);
                loadFile(start);
            }
            let currentFilePath = start;
            let currentRepoId = '<%= repoId %>';

            async function loadFile(filePath) {
                try {
                    const response = await fetch(`/repoDetail/file-content?path=${encodeURIComponent(filePath)}`);
                    currentFilePath = filePath;
                    console.log('loadFile() ê²½ë¡œ: ', currentFilePath);
                    if (!response.ok) throw new Error('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    const content = await response.text();
                    document.getElementById('file-content').textContent = content;
                    document.getElementById('editor').value = content;
                } catch (err) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                }
            }

            async function saveFile() {
                const content = document.getElementById('editor').value;
                if (!currentFilePath) {
                    alert('ì €ì¥í•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return;
                }

                console.log('saveFile() ê²½ë¡œ:', currentFilePath);
                console.log('savdFile() ë‚´ìš©:', content);

                try {
                    const response = await fetch('/repoDetail/edit-file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ filePath: currentFilePath, content }),
                    });
                    if (!response.ok) throw new Error('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨');
                    alert(await response.text());
                    await loadFile(currentFilePath);
                } catch (err) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                }
            }

            async function deleteFile(filePath, repoId) {
                if (!filePath) {
                    alert('ì‚­ì œí•  íŒŒì¼ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                console.log('deleteFile() ê²½ë¡œ : ', filePath);
                console.log('deleteFile() repoID : ', repoId);

                const confirmDelete = confirm('ì •ë§ë¡œ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (!confirmDelete) return;

                try {
                    const response = await fetch('/repoDetail/delete-file', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filePath: filePath,
                            repoId: repoId  // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ repoId
                        }),
                    });
                    if (!response.ok) throw new Error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨');
                    alert(await response.text());
                    location.reload();  // ì‚­ì œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
                } catch (err) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                }
            }

            async function deleteRepo(repoId) {
                const confirmDelete = confirm('ì •ë§ë¡œ ì´ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (!confirmDelete) return;

                try {
                    const response = await fetch('/repoDetail/delete-repo', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            repoId: repoId
                        }),
                    });
                    if (!response.ok) throw new Error('ë ˆí¬ì§€í† ë¦¬ ì‚­ì œ ì‹¤íŒ¨');
                    alert(await response.text());
                    window.location.href = '/';  // ë ˆí¬ì§€í† ë¦¬ ì‚­ì œ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                } catch (err) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                }
            }

            async function uploadFile() {
                const fileInput = document.getElementById('file-upload');
                const repoId = document.querySelector('input[name="repoId"]').value;
                const file = fileInput.files[0];

                if (!file) {
                    alert('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('repoId', repoId);

                try {
                    const response = await fetch('/repoDetail/upload-file', {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
                    alert(await response.text());
                    location.reload();  // ì—…ë¡œë“œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
                } catch (err) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                }
            }

            // íŒŒì¼ ìƒì„± í•¨ìˆ˜
            async function createFile(repoId) {
                const fileName = prompt('ìƒˆ íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
                if (!fileName) {
                    alert('íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                const filePath = currentFilePath;

                try {
                    const response = await fetch('/repoDetail/create-file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ repoId, fileName, filePath}),
                    });

                    if (!response.ok) throw new Error('íŒŒì¼ ìƒì„± ì‹¤íŒ¨');
                    alert(await response.text());
                    location.reload();  // íŒŒì¼ ìƒì„± í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
                } catch (err) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                }
            }
        </script>
        <script>
            function toggleDropdown() {
                const dropdown = document.querySelector('.dropdown');
                dropdown.classList.toggle('show');
            }

            // Open upload modal
            function openUploadModal() {
                document.getElementById('upload-modal').style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'block';
            }

            // Close upload modal
            function closeUploadModal() {
                document.getElementById('upload-modal').style.display = 'none';
                document.getElementById('modal-overlay').style.display = 'none';
            }

            // function createFile() {
            //     alert('Create new file clicked!');
            // }

            // function uploadFiles() {
            //     alert('Upload files clicked!');
            // }

            // Close dropdown if clicked outside
            window.addEventListener('click', (e) => {
                const dropdown = document.querySelector('.dropdown');
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Close modal when clicking overlay
            document.getElementById('modal-overlay').addEventListener('click', closeUploadModal);
        </script>
    </body>
</html>
